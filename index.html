<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Litchiの五十音練習</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX/TS transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide-react.min.js"></script>

    <style>
      body {
        font-family: 'Zen Maru Gothic', 'Noto Sans JP', sans-serif;
        background-color: #fdfcf8; /* Washi paper off-white */
        background-image: radial-gradient(#e5e5e5 1px, transparent 1px);
        background-size: 20px 20px;
      }
      /* Animations */
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes bounce-in {
        0% { opacity: 0; transform: scale(0.9); }
        50% { opacity: 1; transform: scale(1.02); }
        100% { transform: scale(1); }
      }
      .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      .animate-bounce-in { animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
      .animate-spin-slow { animation: spin 10s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      
      /* Selection Color */
      ::selection {
        background-color: #fecdd3; /* rose-200 */
        color: #881337; /* rose-900 */
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
      const { useState, useEffect, useCallback, useMemo } = React;
      // Destructure icons from global lucideReact object
      const { Settings, PlayCircle, Volume2, CheckCircle2, XCircle, ChevronRight, RefreshCw, BarChart2 } = lucideReact;

      // ----------------------------------------------------------------------
      // TYPES (Originally types.ts)
      // ----------------------------------------------------------------------
      type KanaType = 'hiragana' | 'katakana';
      type KanaCategory = 'seion' | 'dakuon' | 'yoon';
      type QuizMode = 'audio-to-kana' | 'kana-to-audio';
      type AudioSource = 'youdao' | 'riyutool' | 'microsoft' | 'google';

      interface KanaChar {
        id: string;
        char: string;
        romaji: string;
        riyutoolKey: string;
        type: KanaType;
        category: KanaCategory;
        origin: string;
      }

      interface GameSettings {
        questionCount: number;
        kanaType: 'hiragana' | 'katakana' | 'mixed';
        category: 'seion' | 'dakuon' | 'yoon' | 'all';
        audioSource: AudioSource;
      }

      interface Question {
        target: KanaChar;
        options: KanaChar[];
      }

      interface GameStats {
        total: number;
        correct: number;
        wrongHistory: Record<string, number>;
      }

      // ----------------------------------------------------------------------
      // DATA (Originally kanaData.ts)
      // ----------------------------------------------------------------------
      const id = (char: string) => `kana_${char}`;

      const rawData: Omit<KanaChar, 'id'>[] = [
        // --- Seion Hiragana ---
        { char: 'あ', romaji: 'a', riyutoolKey: 'a', type: 'hiragana', category: 'seion', origin: '安' },
        { char: 'い', romaji: 'i', riyutoolKey: 'i', type: 'hiragana', category: 'seion', origin: '以' },
        { char: 'う', romaji: 'u', riyutoolKey: 'u', type: 'hiragana', category: 'seion', origin: '宇' },
        { char: 'え', romaji: 'e', riyutoolKey: 'e', type: 'hiragana', category: 'seion', origin: '衣' },
        { char: 'お', romaji: 'o', riyutoolKey: 'o', type: 'hiragana', category: 'seion', origin: '於' },
        
        { char: 'か', romaji: 'ka', riyutoolKey: 'ka', type: 'hiragana', category: 'seion', origin: '加' },
        { char: 'き', romaji: 'ki', riyutoolKey: 'ki', type: 'hiragana', category: 'seion', origin: '幾' },
        { char: 'く', romaji: 'ku', riyutoolKey: 'ku', type: 'hiragana', category: 'seion', origin: '久' },
        { char: 'け', romaji: 'ke', riyutoolKey: 'ke', type: 'hiragana', category: 'seion', origin: '計' },
        { char: 'こ', romaji: 'ko', riyutoolKey: 'ko', type: 'hiragana', category: 'seion', origin: '己' },

        { char: 'さ', romaji: 'sa', riyutoolKey: 'sa', type: 'hiragana', category: 'seion', origin: '左' },
        { char: 'し', romaji: 'shi', riyutoolKey: 'si', type: 'hiragana', category: 'seion', origin: '之' },
        { char: 'す', romaji: 'su', riyutoolKey: 'su', type: 'hiragana', category: 'seion', origin: '寸' },
        { char: 'せ', romaji: 'se', riyutoolKey: 'se', type: 'hiragana', category: 'seion', origin: '世' },
        { char: 'そ', romaji: 'so', riyutoolKey: 'so', type: 'hiragana', category: 'seion', origin: '曽' },

        { char: 'た', romaji: 'ta', riyutoolKey: 'ta', type: 'hiragana', category: 'seion', origin: '太' },
        { char: 'ち', romaji: 'chi', riyutoolKey: 'ti', type: 'hiragana', category: 'seion', origin: '知' },
        { char: 'つ', romaji: 'tsu', riyutoolKey: 'tu', type: 'hiragana', category: 'seion', origin: '川' },
        { char: 'て', romaji: 'te', riyutoolKey: 'te', type: 'hiragana', category: 'seion', origin: '天' },
        { char: 'と', romaji: 'to', riyutoolKey: 'to', type: 'hiragana', category: 'seion', origin: '止' },

        { char: 'な', romaji: 'na', riyutoolKey: 'na', type: 'hiragana', category: 'seion', origin: '奈' },
        { char: 'に', romaji: 'ni', riyutoolKey: 'ni', type: 'hiragana', category: 'seion', origin: '仁' },
        { char: 'ぬ', romaji: 'nu', riyutoolKey: 'nu', type: 'hiragana', category: 'seion', origin: '奴' },
        { char: 'ね', romaji: 'ne', riyutoolKey: 'ne', type: 'hiragana', category: 'seion', origin: '祢' },
        { char: 'の', romaji: 'no', riyutoolKey: 'no', type: 'hiragana', category: 'seion', origin: '乃' },

        { char: 'は', romaji: 'ha', riyutoolKey: 'ha', type: 'hiragana', category: 'seion', origin: '波' },
        { char: 'ひ', romaji: 'hi', riyutoolKey: 'hi', type: 'hiragana', category: 'seion', origin: '比' },
        { char: 'ふ', romaji: 'fu', riyutoolKey: 'hu', type: 'hiragana', category: 'seion', origin: '不' },
        { char: 'へ', romaji: 'he', riyutoolKey: 'he', type: 'hiragana', category: 'seion', origin: '部' },
        { char: 'ほ', romaji: 'ho', riyutoolKey: 'ho', type: 'hiragana', category: 'seion', origin: '保' },

        { char: 'ま', romaji: 'ma', riyutoolKey: 'ma', type: 'hiragana', category: 'seion', origin: '末' },
        { char: 'み', romaji: 'mi', riyutoolKey: 'mi', type: 'hiragana', category: 'seion', origin: '美' },
        { char: 'む', romaji: 'mu', riyutoolKey: 'mu', type: 'hiragana', category: 'seion', origin: '武' },
        { char: 'め', romaji: 'me', riyutoolKey: 'me', type: 'hiragana', category: 'seion', origin: '女' },
        { char: 'も', romaji: 'mo', riyutoolKey: 'mo', type: 'hiragana', category: 'seion', origin: '毛' },

        { char: 'や', romaji: 'ya', riyutoolKey: 'ya', type: 'hiragana', category: 'seion', origin: '也' },
        { char: 'ゆ', romaji: 'yu', riyutoolKey: 'yu', type: 'hiragana', category: 'seion', origin: '由' },
        { char: 'よ', romaji: 'yo', riyutoolKey: 'yo', type: 'hiragana', category: 'seion', origin: '与' },

        { char: 'ら', romaji: 'ra', riyutoolKey: 'ra', type: 'hiragana', category: 'seion', origin: '良' },
        { char: 'り', romaji: 'ri', riyutoolKey: 'ri', type: 'hiragana', category: 'seion', origin: '利' },
        { char: 'る', romaji: 'ru', riyutoolKey: 'ru', type: 'hiragana', category: 'seion', origin: '留' },
        { char: 'れ', romaji: 're', riyutoolKey: 're', type: 'hiragana', category: 'seion', origin: '礼' },
        { char: 'ろ', romaji: 'ro', riyutoolKey: 'ro', type: 'hiragana', category: 'seion', origin: '呂' },

        { char: 'わ', romaji: 'wa', riyutoolKey: 'wa', type: 'hiragana', category: 'seion', origin: '和' },
        { char: 'を', romaji: 'wo', riyutoolKey: 'o', type: 'hiragana', category: 'seion', origin: '遠' },
        { char: 'ん', romaji: 'n', riyutoolKey: 'n', type: 'hiragana', category: 'seion', origin: '无' },

        // --- Seion Katakana ---
        { char: 'ア', romaji: 'a', riyutoolKey: 'a', type: 'katakana', category: 'seion', origin: '阿' },
        { char: 'イ', romaji: 'i', riyutoolKey: 'i', type: 'katakana', category: 'seion', origin: '伊' },
        { char: 'ウ', romaji: 'u', riyutoolKey: 'u', type: 'katakana', category: 'seion', origin: '宇' },
        { char: 'エ', romaji: 'e', riyutoolKey: 'e', type: 'katakana', category: 'seion', origin: '江' },
        { char: 'オ', romaji: 'o', riyutoolKey: 'o', type: 'katakana', category: 'seion', origin: '於' },

        { char: 'カ', romaji: 'ka', riyutoolKey: 'ka', type: 'katakana', category: 'seion', origin: '加' },
        { char: 'キ', romaji: 'ki', riyutoolKey: 'ki', type: 'katakana', category: 'seion', origin: '幾' },
        { char: 'ク', romaji: 'ku', riyutoolKey: 'ku', type: 'katakana', category: 'seion', origin: '久' },
        { char: 'ケ', romaji: 'ke', riyutoolKey: 'ke', type: 'katakana', category: 'seion', origin: '介' },
        { char: 'コ', romaji: 'ko', riyutoolKey: 'ko', type: 'katakana', category: 'seion', origin: '己' },

        { char: 'サ', romaji: 'sa', riyutoolKey: 'sa', type: 'katakana', category: 'seion', origin: '散' },
        { char: 'シ', romaji: 'shi', riyutoolKey: 'si', type: 'katakana', category: 'seion', origin: '之' },
        { char: 'ス', romaji: 'su', riyutoolKey: 'su', type: 'katakana', category: 'seion', origin: '須' },
        { char: 'セ', romaji: 'se', riyutoolKey: 'se', type: 'katakana', category: 'seion', origin: '世' },
        { char: 'ソ', romaji: 'so', riyutoolKey: 'so', type: 'katakana', category: 'seion', origin: '曽' },

        { char: 'タ', romaji: 'ta', riyutoolKey: 'ta', type: 'katakana', category: 'seion', origin: '多' },
        { char: 'チ', romaji: 'chi', riyutoolKey: 'ti', type: 'katakana', category: 'seion', origin: '千' },
        { char: 'ツ', romaji: 'tsu', riyutoolKey: 'tu', type: 'katakana', category: 'seion', origin: '川' },
        { char: 'テ', romaji: 'te', riyutoolKey: 'te', type: 'katakana', category: 'seion', origin: '天' },
        { char: 'ト', romaji: 'to', riyutoolKey: 'to', type: 'katakana', category: 'seion', origin: '止' },

        { char: 'ナ', romaji: 'na', riyutoolKey: 'na', type: 'katakana', category: 'seion', origin: '奈' },
        { char: 'ニ', romaji: 'ni', riyutoolKey: 'ni', type: 'katakana', category: 'seion', origin: '仁' },
        { char: 'ヌ', romaji: 'nu', riyutoolKey: 'nu', type: 'katakana', category: 'seion', origin: '奴' },
        { char: 'ネ', romaji: 'ne', riyutoolKey: 'ne', type: 'katakana', category: 'seion', origin: '祢' },
        { char: 'ノ', romaji: 'no', riyutoolKey: 'no', type: 'katakana', category: 'seion', origin: '乃' },

        { char: 'ハ', romaji: 'ha', riyutoolKey: 'ha', type: 'katakana', category: 'seion', origin: '八' },
        { char: 'ヒ', romaji: 'hi', riyutoolKey: 'hi', type: 'katakana', category: 'seion', origin: '比' },
        { char: 'フ', romaji: 'fu', riyutoolKey: 'hu', type: 'katakana', category: 'seion', origin: '不' },
        { char: 'ヘ', romaji: 'he', riyutoolKey: 'he', type: 'katakana', category: 'seion', origin: '部' },
        { char: 'ホ', romaji: 'ho', riyutoolKey: 'ho', type: 'katakana', category: 'seion', origin: '保' },

        { char: 'マ', romaji: 'ma', riyutoolKey: 'ma', type: 'katakana', category: 'seion', origin: '末' },
        { char: 'ミ', romaji: 'mi', riyutoolKey: 'mi', type: 'katakana', category: 'seion', origin: '三' },
        { char: 'ム', romaji: 'mu', riyutoolKey: 'mu', type: 'katakana', category: 'seion', origin: '牟' },
        { char: 'メ', romaji: 'me', riyutoolKey: 'me', type: 'katakana', category: 'seion', origin: '女' },
        { char: 'モ', romaji: 'mo', riyutoolKey: 'mo', type: 'katakana', category: 'seion', origin: '毛' },

        { char: 'ヤ', romaji: 'ya', riyutoolKey: 'ya', type: 'katakana', category: 'seion', origin: '也' },
        { char: 'ユ', romaji: 'yu', riyutoolKey: 'yu', type: 'katakana', category: 'seion', origin: '由' },
        { char: 'ヨ', romaji: 'yo', riyutoolKey: 'yo', type: 'katakana', category: 'seion', origin: '与' },

        { char: 'ラ', romaji: 'ra', riyutoolKey: 'ra', type: 'katakana', category: 'seion', origin: '良' },
        { char: 'リ', romaji: 'ri', riyutoolKey: 'ri', type: 'katakana', category: 'seion', origin: '利' },
        { char: 'ル', romaji: 'ru', riyutoolKey: 'ru', type: 'katakana', category: 'seion', origin: '流' },
        { char: 'レ', romaji: 're', riyutoolKey: 're', type: 'katakana', category: 'seion', origin: '礼' },
        { char: 'ロ', romaji: 'ro', riyutoolKey: 'ro', type: 'katakana', category: 'seion', origin: '呂' },

        { char: 'ワ', romaji: 'wa', riyutoolKey: 'wa', type: 'katakana', category: 'seion', origin: '和' },
        { char: 'ヲ', romaji: 'wo', riyutoolKey: 'o', type: 'katakana', category: 'seion', origin: '乎' },
        { char: 'ン', romaji: 'n', riyutoolKey: 'n', type: 'katakana', category: 'seion', origin: '尔' },

        // --- Dakuon / Handakuon Hiragana ---
        { char: 'が', romaji: 'ga', riyutoolKey: 'ga', type: 'hiragana', category: 'dakuon', origin: '加' },
        { char: 'ぎ', romaji: 'gi', riyutoolKey: 'gi', type: 'hiragana', category: 'dakuon', origin: '幾' },
        { char: 'ぐ', romaji: 'gu', riyutoolKey: 'gu', type: 'hiragana', category: 'dakuon', origin: '久' },
        { char: 'げ', romaji: 'ge', riyutoolKey: 'ge', type: 'hiragana', category: 'dakuon', origin: '計' },
        { char: 'ご', romaji: 'go', riyutoolKey: 'go', type: 'hiragana', category: 'dakuon', origin: '己' },

        { char: 'ざ', romaji: 'za', riyutoolKey: 'za', type: 'hiragana', category: 'dakuon', origin: '左' },
        { char: 'じ', romaji: 'ji', riyutoolKey: 'zi', type: 'hiragana', category: 'dakuon', origin: '之' },
        { char: 'ず', romaji: 'zu', riyutoolKey: 'zu', type: 'hiragana', category: 'dakuon', origin: '寸' },
        { char: 'ぜ', romaji: 'ze', riyutoolKey: 'ze', type: 'hiragana', category: 'dakuon', origin: '世' },
        { char: 'ぞ', romaji: 'zo', riyutoolKey: 'zo', type: 'hiragana', category: 'dakuon', origin: '曽' },

        { char: 'だ', romaji: 'da', riyutoolKey: 'da', type: 'hiragana', category: 'dakuon', origin: '太' },
        { char: 'ぢ', romaji: 'ji', riyutoolKey: 'di', type: 'hiragana', category: 'dakuon', origin: '知' },
        { char: 'づ', romaji: 'zu', riyutoolKey: 'du', type: 'hiragana', category: 'dakuon', origin: '川' },
        { char: 'で', romaji: 'de', riyutoolKey: 'de', type: 'hiragana', category: 'dakuon', origin: '天' },
        { char: 'ど', romaji: 'do', riyutoolKey: 'do', type: 'hiragana', category: 'dakuon', origin: '止' },

        { char: 'ば', romaji: 'ba', riyutoolKey: 'ba', type: 'hiragana', category: 'dakuon', origin: '波' },
        { char: 'び', romaji: 'bi', riyutoolKey: 'bi', type: 'hiragana', category: 'dakuon', origin: '比' },
        { char: 'ぶ', romaji: 'bu', riyutoolKey: 'bu', type: 'hiragana', category: 'dakuon', origin: '不' },
        { char: 'べ', romaji: 'be', riyutoolKey: 'be', type: 'hiragana', category: 'dakuon', origin: '部' },
        { char: 'ぼ', romaji: 'bo', riyutoolKey: 'bo', type: 'hiragana', category: 'dakuon', origin: '保' },

        { char: 'ぱ', romaji: 'pa', riyutoolKey: 'pa', type: 'hiragana', category: 'dakuon', origin: '波' },
        { char: 'ぴ', romaji: 'pi', riyutoolKey: 'pi', type: 'hiragana', category: 'dakuon', origin: '比' },
        { char: 'ぷ', romaji: 'pu', riyutoolKey: 'pu', type: 'hiragana', category: 'dakuon', origin: '不' },
        { char: 'ぺ', romaji: 'pe', riyutoolKey: 'pe', type: 'hiragana', category: 'dakuon', origin: '部' },
        { char: 'ぽ', romaji: 'po', riyutoolKey: 'po', type: 'hiragana', category: 'dakuon', origin: '保' },

            // --- Dakuon / Handakuon Katakana ---
        { char: 'ガ', romaji: 'ga', riyutoolKey: 'ga', type: 'katakana', category: 'dakuon', origin: '加' },
        { char: 'ギ', romaji: 'gi', riyutoolKey: 'gi', type: 'katakana', category: 'dakuon', origin: '幾' },
        { char: 'グ', romaji: 'gu', riyutoolKey: 'gu', type: 'katakana', category: 'dakuon', origin: '久' },
        { char: 'ゲ', romaji: 'ge', riyutoolKey: 'ge', type: 'katakana', category: 'dakuon', origin: '介' },
        { char: 'ゴ', romaji: 'go', riyutoolKey: 'go', type: 'katakana', category: 'dakuon', origin: '己' },

        { char: 'ザ', romaji: 'za', riyutoolKey: 'za', type: 'katakana', category: 'dakuon', origin: '散' },
        { char: 'ジ', romaji: 'ji', riyutoolKey: 'zi', type: 'katakana', category: 'dakuon', origin: '之' },
        { char: 'ズ', romaji: 'zu', riyutoolKey: 'zu', type: 'katakana', category: 'dakuon', origin: '須' },
        { char: 'ゼ', romaji: 'ze', riyutoolKey: 'ze', type: 'katakana', category: 'dakuon', origin: '世' },
        { char: 'ゾ', romaji: 'zo', riyutoolKey: 'zo', type: 'katakana', category: 'dakuon', origin: '曽' },

        { char: 'ダ', romaji: 'da', riyutoolKey: 'da', type: 'katakana', category: 'dakuon', origin: '多' },
        { char: 'ヂ', romaji: 'ji', riyutoolKey: 'di', type: 'katakana', category: 'dakuon', origin: '千' },
        { char: 'ヅ', romaji: 'zu', riyutoolKey: 'du', type: 'katakana', category: 'dakuon', origin: '川' },
        { char: 'デ', romaji: 'de', riyutoolKey: 'de', type: 'katakana', category: 'dakuon', origin: '天' },
        { char: 'ド', romaji: 'do', riyutoolKey: 'do', type: 'katakana', category: 'dakuon', origin: '止' },

        { char: 'バ', romaji: 'ba', riyutoolKey: 'ba', type: 'katakana', category: 'dakuon', origin: '八' },
        { char: 'ビ', romaji: 'bi', riyutoolKey: 'bi', type: 'katakana', category: 'dakuon', origin: '比' },
        { char: 'ブ', romaji: 'bu', riyutoolKey: 'bu', type: 'katakana', category: 'dakuon', origin: '不' },
        { char: 'ベ', romaji: 'be', riyutoolKey: 'be', type: 'katakana', category: 'dakuon', origin: '部' },
        { char: 'ボ', romaji: 'bo', riyutoolKey: 'bo', type: 'katakana', category: 'dakuon', origin: '保' },

        { char: 'パ', romaji: 'pa', riyutoolKey: 'pa', type: 'katakana', category: 'dakuon', origin: '八' },
        { char: 'ピ', romaji: 'pi', riyutoolKey: 'pi', type: 'katakana', category: 'dakuon', origin: '比' },
        { char: 'プ', romaji: 'pu', riyutoolKey: 'pu', type: 'katakana', category: 'dakuon', origin: '不' },
        { char: 'ペ', romaji: 'pe', riyutoolKey: 'pe', type: 'katakana', category: 'dakuon', origin: '部' },
        { char: 'ポ', romaji: 'po', riyutoolKey: 'po', type: 'katakana', category: 'dakuon', origin: '保' },

        // --- Yoon (Contracted Sounds) Hiragana ---
        { char: 'きゃ', romaji: 'kya', riyutoolKey: 'kya', type: 'hiragana', category: 'yoon', origin: '加也' },
        { char: 'きゅ', romaji: 'kyu', riyutoolKey: 'kyu', type: 'hiragana', category: 'yoon', origin: '加由' },
        { char: 'きょ', romaji: 'kyo', riyutoolKey: 'kyo', type: 'hiragana', category: 'yoon', origin: '加与' },
        { char: 'しゃ', romaji: 'sha', riyutoolKey: 'sya', type: 'hiragana', category: 'yoon', origin: '之也' },
        { char: 'しゅ', romaji: 'shu', riyutoolKey: 'syu', type: 'hiragana', category: 'yoon', origin: '之由' },
        { char: 'しょ', romaji: 'sho', riyutoolKey: 'syo', type: 'hiragana', category: 'yoon', origin: '之与' },
        { char: 'ちゃ', romaji: 'cha', riyutoolKey: 'tya', type: 'hiragana', category: 'yoon', origin: '知也' },
        { char: 'ちゅ', romaji: 'chu', riyutoolKey: 'cyu', type: 'hiragana', category: 'yoon', origin: '知由' },
        { char: 'ちょ', romaji: 'cho', riyutoolKey: 'tyo', type: 'hiragana', category: 'yoon', origin: '知与' },

          // --- Yoon Katakana ---
        { char: 'キャ', romaji: 'kya', riyutoolKey: 'kya', type: 'katakana', category: 'yoon', origin: '加也' },
        { char: 'キュ', romaji: 'kyu', riyutoolKey: 'kyu', type: 'katakana', category: 'yoon', origin: '加由' },
        { char: 'キョ', romaji: 'kyo', riyutoolKey: 'kyo', type: 'katakana', category: 'yoon', origin: '加与' },
        { char: 'シャ', romaji: 'sha', riyutoolKey: 'sya', type: 'katakana', category: 'yoon', origin: '之也' },
        { char: 'シュ', romaji: 'shu', riyutoolKey: 'syu', type: 'katakana', category: 'yoon', origin: '之由' },
        { char: 'ショ', romaji: 'sho', riyutoolKey: 'syo', type: 'katakana', category: 'yoon', origin: '之与' },
      ];

      const kanaData: KanaChar[] = rawData.map(d => ({ ...d, id: id(d.char) }));

      // ----------------------------------------------------------------------
      // AUDIO SERVICE (Originally audioService.ts)
      // ----------------------------------------------------------------------
      class AudioService {
        private static instance: AudioService;
        private currentAudio: HTMLAudioElement | null = null;
        private currentPlayId: number = 0;

        private constructor() {}

        public static getInstance(): AudioService {
          if (!AudioService.instance) {
            AudioService.instance = new AudioService();
          }
          return AudioService.instance;
        }

        public async play(kana: KanaChar, source: AudioSource, times: number = 1): Promise<void> {
          // Generate a new ID for this playback session
          const playId = ++this.currentPlayId;
          
          this.stop(); // Stop any currently playing audio

          const playOnce = () => {
            return new Promise<void>((resolve, reject) => {
              // If this session has been superseded, abort immediately
              if (this.currentPlayId !== playId) {
                  reject(new DOMException('Interrupted', 'AbortError'));
                  return;
              }

              if (source === 'microsoft') {
                // Web Speech API
                const utterance = new SpeechSynthesisUtterance(kana.char);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9;
                
                utterance.onend = () => resolve();
                utterance.onerror = (e) => {
                    if (e.error === 'interrupted' || e.error === 'canceled') {
                        reject(new DOMException('Interrupted', 'AbortError'));
                    } else {
                        reject(e);
                    }
                };
                
                window.speechSynthesis.speak(utterance);
              } else {
                // HTML Audio
                let url = '';
                if (source === 'youdao') {
                  url = `https://dict.youdao.com/dictvoice?audio=${kana.char}&le=jap`;
                } else if (source === 'riyutool') {
                  url = `https://riyutool.com/50yintuceshi/${kana.riyutoolKey}.mp3`;
                } else if (source === 'google') {
                  url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&q=${kana.char}&tl=ja`;
                }

                if (!url) {
                  reject('No URL generated');
                  return;
                }

                const audio = new Audio(url);
                this.currentAudio = audio;
                
                audio.onended = () => resolve();
                audio.onerror = (e) => reject(e);
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        // Handle browser auto-play policy or interruption errors
                        if (e.name === 'AbortError' || e.message?.includes('interrupted')) {
                            reject(new DOMException('Interrupted', 'AbortError'));
                        } else {
                            reject(e);
                        }
                    });
                }
              }
            });
          };

          try {
            for (let i = 0; i < times; i++) {
              // Check if a new playback request has started
              if (this.currentPlayId !== playId) return;

              await playOnce();
              
              if (i < times - 1) {
                if (this.currentPlayId !== playId) return;
                await new Promise(r => setTimeout(r, 300)); // Pause between repeats
              }
            }
          } catch (error: any) {
            // Gracefully handle expected interruption errors
            if (error?.name === 'AbortError' || error?.message?.includes('interrupted')) {
              return;
            }
            console.error("Audio playback failed", error);
          }
        }

        public stop() {
          if (this.currentAudio) {
            try {
              this.currentAudio.pause();
              this.currentAudio.currentTime = 0;
            } catch (e) {
              // Ignore errors during stopping (e.g. if audio wasn't loaded fully)
            }
            this.currentAudio = null;
          }
          window.speechSynthesis.cancel();
        }
      }

      // ----------------------------------------------------------------------
      // COMPONENTS (Originally App.tsx & components/SakuraIcon.tsx)
      // ----------------------------------------------------------------------
      
      const SakuraIcon: React.FC<{ className?: string }> = ({ className }) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 100 100" 
          className={className}
          fill="currentColor"
        >
          <path d="M50,45 C45,30 20,20 20,40 C20,55 45,55 50,55 C55,55 80,55 80,40 C80,20 55,30 50,45 Z" />
          <path d="M50,45 C55,30 80,20 80,40 C80,55 55,55 50,55 C45,55 20,55 20,40 C20,20 45,30 50,45 Z" transform="rotate(72 50 50)" />
          <path d="M50,45 C55,30 80,20 80,40 C80,55 55,55 50,55 C45,55 20,55 20,40 C20,20 45,30 50,45 Z" transform="rotate(144 50 50)" />
          <path d="M50,45 C55,30 80,20 80,40 C80,55 55,55 50,55 C45,55 20,55 20,40 C20,20 45,30 50,45 Z" transform="rotate(216 50 50)" />
          <path d="M50,45 C55,30 80,20 80,40 C80,55 55,55 50,55 C45,55 20,55 20,40 C20,20 45,30 50,45 Z" transform="rotate(288 50 50)" />
          <circle cx="50" cy="50" r="5" fill="#FFF" opacity="0.6" />
        </svg>
      );

      // --- Constants ---
      const AUDIO_SOURCES: { value: AudioSource; label: string }[] = [
        { value: 'youdao', label: '有道 (Youdao) - Recommended' },
        { value: 'riyutool', label: 'Riyutool (Romanized)' },
        { value: 'microsoft', label: 'Microsoft Web Speech' },
        { value: 'google', label: 'Google Translate' },
      ];

      const QUESTION_COUNTS = Array.from({ length: 19 }, (_, i) => (i + 1) * 10 + 10);

      // --- Utility Functions ---
      const shuffleArray = <T,>(array: T[]): T[] => {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      };

      // --- Main Components ---
      const Header: React.FC = () => (
        <header className="sticky top-0 z-10 bg-white/90 backdrop-blur-md shadow-sm border-b border-rose-100 py-3 px-4 flex items-center justify-center gap-3">
          <SakuraIcon className="w-8 h-8 text-rose-400 animate-spin-slow" />
          <h1 className="text-xl md:text-2xl font-bold text-gray-800 tracking-wide font-['Zen_Maru_Gothic']">
            Litchiの五十音練習
          </h1>
        </header>
      );

      const HomeScreen: React.FC<{ 
        settings: GameSettings; 
        setSettings: React.Dispatch<React.SetStateAction<GameSettings>>; 
        onStart: (mode: QuizMode) => void;
      }> = ({ settings, setSettings, onStart }) => {
        const testAudio = () => {
          // Test with 'a' (あ)
          const sample = kanaData.find(k => k.romaji === 'a' && k.type === 'hiragana');
          if (sample) {
            AudioService.getInstance().play(sample, settings.audioSource, 2);
          }
        };

        return (
          <div className="max-w-6xl mx-auto p-6 animate-fade-in flex flex-col justify-center min-h-[80vh]">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16 items-center">
              
              {/* Left Column: Intro & Actions (Desktop: Order 1) */}
              <div className="space-y-8 order-2 md:order-1">
                <div className="space-y-4 text-center md:text-left">
                  <h2 className="text-4xl md:text-5xl lg:text-6xl font-bold text-gray-800 leading-tight font-['Zen_Maru_Gothic']">
                    <span className="text-rose-500">五十音</span>を<br/>
                    マスターしよう
                  </h2>
                  <p className="text-gray-500 text-lg md:text-xl">
                    Start your journey into Japanese with our comprehensive Kana practice tool.
                  </p>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 lg:grid-cols-2 gap-4">
                  <button 
                    onClick={() => onStart('audio-to-kana')}
                    className="py-5 px-6 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl shadow-xl hover:shadow-2xl hover:-translate-y-1 transform transition-all flex items-center justify-center gap-3 font-bold text-lg"
                  >
                    <div className="bg-white/20 p-2 rounded-full"><Volume2 className="w-6 h-6" /></div>
                    <div className="text-left">
                      <div className="text-xs opacity-90">Listen & Select</div>
                      <div>発音 ➡ 五十音</div>
                    </div>
                  </button>
                  <button 
                    onClick={() => onStart('kana-to-audio')}
                    className="py-5 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl shadow-xl hover:shadow-2xl hover:-translate-y-1 transform transition-all flex items-center justify-center gap-3 font-bold text-lg"
                  >
                    <div className="bg-white/20 p-2 rounded-full"><span className="text-xl font-serif">あ</span></div>
                    <div className="text-left">
                      <div className="text-xs opacity-90">Read & Select</div>
                      <div>五十音 ➡ 発音</div>
                    </div>
                  </button>
                </div>
              </div>

              {/* Right Column: Settings Card (Desktop: Order 2) */}
              <div className="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-rose-100 relative order-1 md:order-2">
                <div className="absolute -top-4 -right-4 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full shadow-md rotate-12">
                  Customize!
                </div>
                
                <h3 className="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2 border-b border-gray-100 pb-4">
                  <Settings className="text-rose-400" /> 
                  設定 (Settings)
                </h3>
                
                <div className="space-y-6">
                  {/* Audio Source */}
                  <div className="relative z-50">
                    <label className="block text-sm font-medium text-gray-700 mb-2">音声ソース (Audio Source)</label>
                    <div className="flex gap-2">
                      <select 
                        className="block w-full rounded-xl border-gray-300 bg-gray-50 p-3 text-sm focus:border-rose-500 focus:ring-rose-500 shadow-sm transition-shadow hover:bg-white"
                        value={settings.audioSource}
                        onChange={(e) => setSettings({ ...settings, audioSource: e.target.value as AudioSource })}
                      >
                        {AUDIO_SOURCES.map(src => (
                          <option key={src.value} value={src.value}>{src.label}</option>
                        ))}
                      </select>
                      <button 
                        onClick={testAudio}
                        className="px-4 bg-indigo-100 text-indigo-700 rounded-xl hover:bg-indigo-200 transition-colors flex items-center justify-center"
                        title="Test Audio"
                      >
                        <Volume2 size={20} />
                      </button>
                    </div>
                  </div>

                  {/* Question Count */}
                  <div className="relative z-40">
                    <div className="flex justify-between mb-2">
                      <label className="text-sm font-medium text-gray-700">問題数 (Count)</label>
                      <span className="text-sm font-bold text-rose-500 bg-rose-50 px-2 rounded-md">{settings.questionCount}</span>
                    </div>
                    <input 
                      type="range" 
                      min="20" 
                      max="200" 
                      step="10"
                      value={settings.questionCount}
                      onChange={(e) => setSettings({ ...settings, questionCount: Number(e.target.value) })}
                      className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-rose-500"
                    />
                    <div className="flex justify-between text-xs text-gray-400 mt-1">
                      <span>20</span>
                      <span>200</span>
                    </div>
                  </div>

                  {/* Kana Type */}
                  <div className="relative z-30">
                    <label className="block text-sm font-medium text-gray-700 mb-2">文字 (Script)</label>
                    <div className="grid grid-cols-3 gap-2">
                      {(['hiragana', 'katakana', 'mixed']).map(type => (
                        <button
                          key={type}
                          onClick={() => setSettings({ ...settings, kanaType: type })}
                          className={`py-2 px-1 rounded-xl text-sm font-medium transition-all border-2 ${
                            settings.kanaType === type 
                              ? 'bg-rose-50 border-rose-400 text-rose-600' 
                              : 'bg-white border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-200'
                          }`}
                        >
                          {type === 'hiragana' ? 'あ Hiragana' : type === 'katakana' ? 'ア Katakana' : 'Mix'}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Category */}
                  <div className="relative z-20">
                    <label className="block text-sm font-medium text-gray-700 mb-2">種類 (Category)</label>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                      {(['seion', 'dakuon', 'yoon', 'all']).map(cat => (
                        <button
                          key={cat}
                          onClick={() => setSettings({ ...settings, category: cat })}
                          className={`py-2 px-1 rounded-xl text-xs sm:text-sm font-medium transition-all border-2 ${
                            settings.category === cat 
                              ? 'bg-indigo-50 border-indigo-400 text-indigo-600' 
                              : 'bg-white border-transparent text-gray-500 hover:bg-gray-50 hover:border-gray-200'
                          }`}
                        >
                          {cat === 'seion' ? '清音' : 
                          cat === 'dakuon' ? '濁音' : 
                          cat === 'yoon' ? '拗音' : 'All'}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const QuizScreen: React.FC<{
        mode: QuizMode;
        settings: GameSettings;
        onFinish: (stats: GameStats) => void;
        onExit: () => void;
      }> = ({ mode, settings, onFinish, onExit }) => {
        const [questions, setQuestions] = useState<Question[]>([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [stats, setStats] = useState<GameStats>({ total: 0, correct: 0, wrongHistory: {} });
        const [selectedOption, setSelectedOption] = useState<KanaChar | null>(null);
        const [isAnswered, setIsAnswered] = useState(false);
        const [loading, setLoading] = useState(true);

        // Initialize Game
        useEffect(() => {
          // Filter Data
          let pool = kanaData.filter(k => {
            // Level 1: Script
            if (settings.kanaType !== 'mixed' && k.type !== settings.kanaType) return false;
            // Level 2: Category
            if (settings.category !== 'all' && k.category !== settings.category) return false;
            return true;
          });

          // Ensure we have enough data (fallback to all if filter is too strict/broken)
          if (pool.length < 5) pool = kanaData;

          const gameQuestions: Question[] = [];
          const count = Math.min(settings.questionCount, pool.length); // Don't exceed pool size
          
          // Pick unique targets
          const targets = shuffleArray(pool).slice(0, count);

          targets.forEach(target => {
            // Pick 4 distractors from the SAME filtered pool
            const others = pool.filter(k => k.id !== target.id);
            const distractors = shuffleArray(others).slice(0, 4);
            const options = shuffleArray([target, ...distractors]);
            gameQuestions.push({ target, options });
          });

          setQuestions(gameQuestions);
          setLoading(false);
        }, [settings]);

        // Audio Auto-play for current question
        useEffect(() => {
          if (!loading && questions[currentIndex] && !isAnswered) {
            // Play twice
            AudioService.getInstance().play(questions[currentIndex].target, settings.audioSource, 2);
          }
        }, [currentIndex, loading, questions, isAnswered, settings.audioSource]);

        const handleSelect = (option: KanaChar) => {
          if (isAnswered && mode === 'audio-to-kana') return; // Lock if answered in mode 1
          setSelectedOption(option);
          
          // For mode 2, play sound on selection
          if (mode === 'kana-to-audio') {
            AudioService.getInstance().play(option, settings.audioSource, 1);
          } else {
              // Mode 1: Immediate confirmation
              confirmAnswer(option);
          }
        };

        const confirmAnswer = (chosen: KanaChar) => {
          setIsAnswered(true);
          const correct = questions[currentIndex].target;
          const isCorrect = chosen.id === correct.id;

          setStats(prev => ({
            ...prev,
            total: prev.total + 1,
            correct: isCorrect ? prev.correct + 1 : prev.correct,
            wrongHistory: isCorrect ? prev.wrongHistory : {
              ...prev.wrongHistory,
              [correct.id]: (prev.wrongHistory[correct.id] || 0) + 1
            }
          }));
        };

        const nextQuestion = () => {
          if (currentIndex < questions.length - 1) {
            setCurrentIndex(prev => prev + 1);
            setIsAnswered(false);
            setSelectedOption(null);
          } else {
            onFinish(stats);
          }
        };

        if (loading || questions.length === 0) return <div className="flex justify-center p-10 min-h-screen items-center"><RefreshCw className="animate-spin text-rose-500 w-10 h-10" /></div>;

        const currentQ = questions[currentIndex];
        const isCorrect = selectedOption?.id === currentQ.target.id;

        return (
          <div className="max-w-5xl mx-auto p-4 md:p-8 flex flex-col min-h-[calc(100vh-80px)]">
            {/* Top Bar: Progress & Exit */}
            <div className="w-full max-w-4xl mx-auto mb-6 md:mb-12">
              <div className="flex justify-between items-end mb-2">
                  <span className="text-2xl font-bold text-gray-300 font-mono">
                      {(currentIndex + 1).toString().padStart(2, '0')}
                      <span className="text-sm text-gray-300 mx-1">/</span>
                      <span className="text-sm text-gray-300">{questions.length}</span>
                  </span>
                  <button onClick={onExit} className="text-sm text-gray-400 hover:text-red-500 transition-colors px-3 py-1 rounded hover:bg-red-50">Exit</button>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-3 shadow-inner overflow-hidden">
                  <div 
                  className="bg-gradient-to-r from-rose-400 to-rose-500 h-full rounded-full transition-all duration-500 ease-out" 
                  style={{ width: `${((currentIndex + 1) / questions.length) * 100}%` }}
                  />
              </div>
            </div>

            <div className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-8 lg:gap-20">
              
              {/* Question Area - Left on Desktop */}
              <div className="flex-1 flex flex-col items-center justify-center w-full lg:w-auto lg:items-end">
                  {mode === 'audio-to-kana' ? (
                      // Mode 1: Big Audio Button
                      <button 
                        onClick={() => AudioService.getInstance().play(currentQ.target, settings.audioSource, 1)}
                        className="w-40 h-40 md:w-56 md:h-56 rounded-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 flex flex-col items-center justify-center transition-all active:scale-95 shadow-2xl border-8 border-white ring-4 ring-indigo-50 group"
                      >
                        <Volume2 className="w-16 h-16 md:w-24 md:h-24 mb-2 group-hover:scale-110 transition-transform" />
                        <span className="font-bold text-xl md:text-2xl opacity-50 group-hover:opacity-100 transition-opacity">Play</span>
                      </button>
                  ) : (
                      // Mode 2: Big Kana
                      <div className="text-center lg:text-right">
                          <div className={`text-[120px] md:text-[180px] leading-none font-bold transition-all duration-300 filter drop-shadow-lg ${
                              isAnswered 
                                  ? (isCorrect ? 'text-emerald-500' : 'text-rose-500') 
                                  : 'text-gray-800'
                          }`}>
                              {currentQ.target.char}
                          </div>
                          {/* Only show romaji result after answer */}
                          <div className={`text-3xl md:text-4xl font-medium text-gray-600 h-10 transition-opacity ${isAnswered ? 'opacity-100' : 'opacity-0'}`}>
                              {isAnswered ? currentQ.target.romaji : ''}
                          </div>
                          
                          <div className="text-gray-400 mt-4 text-base font-serif border-t-2 border-gray-100 pt-2 inline-block">
                              Origin: <span className="text-gray-600 font-bold">{currentQ.target.origin}</span>
                          </div>
                      </div>
                  )}
              </div>

              {/* Options Area - Right on Desktop */}
              <div className="flex-1 w-full max-w-3xl">
                  <div className={`grid grid-cols-5 gap-3 md:gap-6 ${mode === 'audio-to-kana' ? '' : 'lg:w-full'}`}>
                      {currentQ.options.map((opt) => {
                          const isSelected = selectedOption?.id === opt.id;
                          const isTarget = opt.id === currentQ.target.id;
                          
                          let btnClass = "relative flex flex-col items-center justify-center rounded-2xl border-b-4 transition-all duration-200 aspect-square lg:aspect-[4/3] ";
                          
                          if (mode === 'audio-to-kana') {
                              // Mode 1 logic
                              if (isAnswered) {
                                  if (isTarget) btnClass += "bg-emerald-100 border-emerald-500 text-emerald-800 shadow-none translate-y-1 "; // Correct
                                  else if (isSelected && !isTarget) btnClass += "bg-rose-100 border-rose-500 text-rose-800 opacity-60 shadow-none translate-y-1 "; // Wrong
                                  else btnClass += "bg-white border-gray-200 text-gray-300 opacity-40 shadow-none "; // Others
                              } else {
                                  btnClass += "bg-white border-gray-200 hover:border-rose-300 hover:bg-rose-50 shadow-md hover:-translate-y-1 cursor-pointer active:translate-y-0 active:shadow-none ";
                              }

                              return (
                                  <button 
                                      key={opt.id} 
                                      disabled={isAnswered}
                                      onClick={() => handleSelect(opt)}
                                      className={btnClass}
                                  >
                                      <span className="text-3xl md:text-5xl font-bold mb-1">{opt.char}</span>
                                      {isAnswered && (
                                          <div className="absolute bottom-1 md:bottom-2 flex flex-col items-center text-[10px] md:text-xs font-medium animate-fade-in w-full">
                                              <span>{opt.romaji}</span>
                                              <span className="opacity-70 scale-90">{opt.origin}</span>
                                          </div>
                                      )}
                                  </button>
                              );
                          } else {
                              // Mode 2 logic (Kana -> Select Audio)
                              if (isAnswered) {
                                  if (isTarget) btnClass += "bg-emerald-100 border-emerald-500 text-emerald-700 shadow-none translate-y-1 ";
                                  else if (isSelected && !isTarget) btnClass += "bg-rose-100 border-rose-500 text-rose-700 opacity-60 shadow-none translate-y-1 ";
                                  else btnClass += "bg-white border-gray-200 text-gray-300 opacity-40 shadow-none ";
                              } else {
                                  btnClass += isSelected 
                                      ? "bg-indigo-100 border-indigo-500 text-indigo-700 translate-y-1 shadow-inner " 
                                      : "bg-white border-gray-200 text-gray-600 hover:bg-indigo-50 hover:border-indigo-300 shadow-md hover:-translate-y-1 ";
                              }

                              return (
                                  <button
                                      key={opt.id}
                                      disabled={isAnswered}
                                      onClick={() => handleSelect(opt)}
                                      className={btnClass}
                                  >
                                      <Volume2 className={`w-6 h-6 md:w-8 md:h-8 mb-1 md:mb-2 ${isAnswered && isTarget ? 'text-emerald-600' : 'inherit'}`} />
                                      {isAnswered && (
                                          <div className="absolute bottom-1 md:bottom-2 flex flex-col items-center text-[10px] md:text-xs font-medium animate-fade-in w-full leading-tight">
                                              <span className="text-sm font-bold">{opt.char}</span>
                                              <span>{opt.romaji}</span>
                                          </div>
                                      )}
                                  </button>
                              );
                          }
                      })}
                  </div>

                  {/* Action Area for Mode 2 */}
                  {mode === 'kana-to-audio' && !isAnswered && (
                      <div className="flex justify-center mt-8 h-14">
                          {selectedOption && (
                              <button 
                                  onClick={() => selectedOption && confirmAnswer(selectedOption)}
                                  className="bg-indigo-600 hover:bg-indigo-700 text-white px-12 py-3 rounded-full font-bold shadow-xl hover:shadow-2xl transition-all active:scale-95 flex items-center gap-3 text-lg animate-fade-in"
                              >
                                  確認 (Confirm) <CheckCircle2 size={24} />
                              </button>
                          )}
                      </div>
                  )}

                  {/* Next Button */}
                  {isAnswered && (
                      <div className="flex justify-center mt-8 h-14">
                          <button 
                          onClick={nextQuestion}
                          className="bg-rose-500 hover:bg-rose-600 text-white px-12 py-3 rounded-full font-bold shadow-xl hover:shadow-2xl transition-all active:scale-95 flex items-center gap-3 text-lg animate-bounce-in"
                          >
                          次へ (Next) <ChevronRight size={24} />
                          </button>
                      </div>
                  )}
              </div>

            </div>
          </div>
        );
      };

      const SummaryScreen: React.FC<{
        stats: GameStats;
        onHome: () => void;
      }> = ({ stats, onHome }) => {
        const percentage = Math.round((stats.correct / stats.total) * 100) || 0;
        
        // Calculate top 10 wrong
        const topErrors = Object.entries(stats.wrongHistory)
          .sort((a, b) => (b[1]) - (a[1]))
          .slice(0, 10)
          .map(([id, count]) => {
              const char = kanaData.find(k => k.id === id);
              return { char, count };
          });

        return (
          <div className="max-w-4xl mx-auto p-6 flex flex-col items-center justify-center min-h-[80vh] animate-fade-in">
              
              <div className="text-center mb-12">
                  <div className="inline-block p-4 rounded-full bg-white shadow-lg mb-6">
                      {percentage >= 80 ? <CheckCircle2 className="w-16 h-16 text-emerald-500" /> : <BarChart2 className="w-16 h-16 text-rose-500" />}
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-gray-800 mb-2">結果発表 (Result)</h2>
                  <div className={`text-8xl font-bold tracking-tighter my-4 ${percentage >= 80 ? 'text-emerald-500' : percentage >= 50 ? 'text-amber-500' : 'text-rose-500'}`}>
                      {percentage}<span className="text-4xl align-top">%</span>
                  </div>
                  <p className="text-xl text-gray-500">Correct: <span className="font-bold text-gray-800">{stats.correct}</span> / {stats.total}</p>
              </div>

              {topErrors.length > 0 && (
                  <div className="w-full bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-rose-100 mb-10">
                      <h3 className="flex items-center gap-3 text-xl font-bold text-rose-500 mb-6 pb-4 border-b border-rose-50">
                          <XCircle size={24} /> 苦手な文字 (Needs Practice)
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {topErrors.map((item, idx) => (
                              <div key={idx} className="flex items-center justify-between bg-rose-50/50 p-3 rounded-xl border border-rose-100">
                                  <div className="flex items-center gap-3">
                                      <span className="text-3xl font-bold w-10 text-center text-gray-800">{item.char?.char}</span>
                                      <div className="text-sm text-gray-500 flex flex-col">
                                          <span className="font-bold text-gray-700 text-base">{item.char?.romaji}</span>
                                          <span className="text-xs">Origin: {item.char?.origin}</span>
                                      </div>
                                  </div>
                                  <span className="bg-white text-rose-500 font-bold px-3 py-1 rounded-lg shadow-sm text-sm">x{item.count}</span>
                              </div>
                          ))}
                      </div>
                  </div>
              )}

              <button 
                  onClick={onHome}
                  className="px-12 py-4 bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-900 hover:shadow-xl transition-all hover:-translate-y-1 flex items-center justify-center gap-3 font-bold text-lg"
              >
                  <RefreshCw size={24} /> ホームに戻る (Back to Home)
              </button>
          </div>
        );
      };

      const App: React.FC = () => {
        const [screen, setScreen] = useState<'home' | 'quiz' | 'summary'>('home');
        const [quizMode, setQuizMode] = useState<QuizMode>('audio-to-kana');
        const [settings, setSettings] = useState<GameSettings>({
          questionCount: 20,
          kanaType: 'hiragana',
          category: 'all',
          audioSource: 'youdao'
        });
        const [lastStats, setLastStats] = useState<GameStats>({ total: 0, correct: 0, wrongHistory: {} });

        const startQuiz = (mode: QuizMode) => {
          setQuizMode(mode);
          setScreen('quiz');
        };

        const finishQuiz = (stats: GameStats) => {
          setLastStats(stats);
          setScreen('summary');
        };

        return (
          <div className="min-h-screen font-sans text-gray-800 bg-[#fdfcf8] selection:bg-rose-200">
            <Header />
            <main className="container mx-auto pb-8">
              {screen === 'home' && (
                <HomeScreen settings={settings} setSettings={setSettings} onStart={startQuiz} />
              )}
              {screen === 'quiz' && (
                <QuizScreen 
                  mode={quizMode} 
                  settings={settings} 
                  onFinish={finishQuiz} 
                  onExit={() => setScreen('home')} 
                />
              )}
              {screen === 'summary' && (
                <SummaryScreen stats={lastStats} onHome={() => setScreen('home')} />
              )}
            </main>
            
            {/* Footer / Copyright */}
            <footer className="text-center py-6 text-gray-400 text-sm opacity-50 hover:opacity-100 transition-opacity">
              <p>&copy; 2024 Litchiの五十音練習</p>
            </footer>
          </div>
        );
      };

      // ----------------------------------------------------------------------
      // RENDER
      // ----------------------------------------------------------------------
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>